# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

## –î–∞—Ç–∞: 26 –æ–∫—Ç—è–±—Ä—è 2025

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –≤–Ω–µ—Å—ë–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ `project-architecture-analysis.plan.md`.

---

## ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–´)

### 1. ‚úÖ shiftMonitor —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** `shiftMonitor` —Å–æ–∑–¥–∞–≤–∞–ª —Ç–æ–ª—å–∫–æ `exceptions`, –Ω–æ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª `violations` –∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª —Ä–µ–π—Ç–∏–Ω–≥–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω—ë–Ω —Ñ–∞–π–ª `server/services/shiftMonitor.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ú–µ—Ç–æ–¥ `createExceptionsFromViolations()` —Ç–µ–ø–µ—Ä—å:
  1. –°–æ–∑–¥–∞—ë—Ç `exception` (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
  2. –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏
  3. –°–æ–∑–¥–∞—ë—Ç `violation` —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–æ–º
  4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ `storage.updateEmployeeRatingFromViolations()`
  5. –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ –Ω–∞—Ä—É—à–µ–Ω–∏–π –Ω–∞ –∫–æ–¥—ã –ø—Ä–∞–≤–∏–ª:**
```typescript
const ruleCodeMap: Record<string, string> = {
  'late_start': 'late',
  'early_end': 'early_end',
  'missed_shift': 'missed_shift',
  'long_break': 'long_break',
  'no_break_end': 'no_break_end'
};
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

---

### 2. ‚úÖ Cache –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–ª–∞—Å—å, –Ω–æ –Ω–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª–∞—Å—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–º–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –≤–æ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏.

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

#### `server/routes.ts`
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `cache` –∏–∑ `./lib/cache.js`
- **POST /api/shifts** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–º–µ–Ω—ã
- **POST /api/shifts/:id/start** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã
- **POST /api/shifts/:id/end** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–º–µ–Ω—ã

#### `server/telegram/handlers/shiftActions.ts`
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `cache` –∏–∑ `../../lib/cache`
- **case 'start_shift'** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã
- **case 'end_shift'** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–º–µ–Ω—ã

**–ö–æ–¥ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
```typescript
// Invalidate company stats cache
const employee = await storage.getEmployee(employeeId);
if (employee) {
  cache.delete(`company:${employee.company_id}:stats`);
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Dashboard —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –ø–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–º–µ–Ω.

---

### 3. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Ä—É—à–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `shiftMonitor.runGlobalMonitoring()` —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω Scheduler Service –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á.

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `server/services/scheduler.ts`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–º–µ–Ω** - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - –í—ã–∑—ã–≤–∞–µ—Ç `shiftMonitor.runGlobalMonitoring()`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

2. **–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π** - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
   - –ü–æ–ª—É—á–∞–µ—Ç `storage.getPendingReminders()`
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ Telegram
   - –ü–æ–º–µ—á–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `storage.markReminderSent()`

3. **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–¥–∞—á

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `server/index.ts`:**
```typescript
// –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
scheduler.startAll();

// –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
process.on('SIGTERM', () => {
  scheduler.stopAll();
  server.close(() => process.exit(0));
});
```

**–ú–µ—Ç–æ–¥—ã Scheduler:**
- `startShiftMonitoring(intervalMinutes)` - –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- `stopShiftMonitoring()` - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- `startRemindersSending(intervalMinutes)` - –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
- `stopRemindersSending()` - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É
- `startAll()` - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏
- `stopAll()` - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –ù–∞—Ä—É—à–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–µ—Ä–∞

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. ‚úÖ `server/services/shiftMonitor.ts` - **120+ —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ** (violations + exception linking)
2. ‚úÖ `server/routes.ts` - **3 –±–ª–æ–∫–∞ cache invalidation** + import cache
3. ‚úÖ `server/telegram/handlers/shiftActions.ts` - **2 –±–ª–æ–∫–∞ cache invalidation** + import cache
4. ‚úÖ `server/services/scheduler.ts` - **–ù–û–í–´–ô –§–ê–ô–õ** (157 —Å—Ç—Ä–æ–∫)
5. ‚úÖ `server/index.ts` - **–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è scheduler** + graceful shutdown
6. ‚úÖ `shared/schema.ts` - **–¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ** `violation_id` –≤ exception
7. ‚úÖ `migrations/0002_add_violation_id_to_exception.sql` - **–ù–û–í–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø**

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ violations –∏–∑ exceptions
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö
- ‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–∫–∞—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Ä—É—à–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ Graceful shutdown –¥–ª—è –≤—Å–µ—Ö background –∑–∞–¥–∞—á
- ‚úÖ –°–≤—è–∑—å exception ‚Üî violation —á–µ—Ä–µ–∑ foreign key

### –£—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- ‚úÖ –†–∞–∑—Ä—ã–≤ —Ü–µ–ø–æ—á–∫–∏: exceptions ‚Üí violations ‚Üí ratings (–ò–°–ü–†–ê–í–õ–ï–ù–û)
- ‚úÖ –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—ç—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
- ‚úÖ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã storage –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–¢–ï–ü–ï–†–¨ –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø)
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É exception –∏ violation (–ò–°–ü–†–ê–í–õ–ï–ù–û)

---

## ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–ª—É—á—à–µ–Ω–∏—è (–ß–ê–°–¢–ò–ß–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)

### 4. ‚úÖ –°–≤—è–∑—å exception ‚Üî violation –¥–æ–±–∞–≤–ª–µ–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∞–±–ª–∏—Ü—ã `exception` –∏ `violations` —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –Ω–µ –±—ã–ª–æ —Å–ø–æ—Å–æ–±–∞ —Å–≤—è–∑–∞—Ç—å exception —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º violation.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `violation_id` –≤ —Ç–∞–±–ª–∏—Ü—É `exception`.

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

#### `migrations/0002_add_violation_id_to_exception.sql` (–ù–û–í–´–ô)
```sql
ALTER TABLE "exception" ADD COLUMN "violation_id" uuid;
ALTER TABLE "exception" ADD CONSTRAINT "exception_violation_id_violations_id_fk" 
  FOREIGN KEY ("violation_id") REFERENCES "violations"("id") ON DELETE SET NULL;
CREATE INDEX "idx_exception_violation_id" ON "exception"("violation_id");
```

#### `shared/schema.ts`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `violation_id` –≤ —Å—Ö–µ–º—É `exception`:
```typescript
violation_id: uuid("violation_id").references(() => violations.id, { onDelete: "set null" }),
```

#### `server/services/shiftMonitor.ts`
- –ò–∑–º–µ–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ violation, –ø–æ—Ç–æ–º exception
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ violation
- Exception —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ violation:
```typescript
const createdViolation = await storage.createViolation({...});
violationId = createdViolation.id;

const exception: InsertException = {
  ...
  violation_id: violationId
};
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π exception —è–≤–Ω–æ —Å–≤—è–∑–∞–Ω —Å violation, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –û—Ç—Å–ª–µ–¥–∏—Ç—å, –∫–∞–∫–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–≤–µ–ª–æ –∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—é
- –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —à—Ç—Ä–∞—Ñ–µ –∏–∑ violation
- –ò–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2-3)

### –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã):

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–æ—Å—Ç–∞–ª–æ—Å—å):
5. **Telegram bot webhook** - –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å polling –Ω–∞ webhook –¥–ª—è production
   - –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤–µ–±—Ö—É–∫–∞ –≤ `server/telegram/webhook.ts`
   - –ò–∑–º–µ–Ω–∏—Ç—å `server/launchBot.ts` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è webhook –≤ prod

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:
1. **–£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Services** - ShiftService, RatingService
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å absence, report handlers** - –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å
3. **–ê—É–¥–∏—Ç UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** - —É–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–∑ components/ui/

#### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–æ—Å—Ç–∞–ª–æ—Å—å):
1. ‚úÖ **–°–≤—è–∑–∞—Ç—å exception ‚Üî violation** - –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
2. **–î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - middleware –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. **WebSocket –¥–ª—è real-time** - live updates –Ω–∞ Dashboard
4. **React Query invalidation** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

#### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
npm run dev

# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
# "Schedulers started"
# "Running global shift monitoring..."
# "Shift monitoring completed: X companies, Y violations, Z exceptions"
```

#### 2. Cache invalidation:
```bash
# 1. –û—Ç–∫—Ä—ã—Ç—å Dashboard –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# 2. –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
# 3. –û–±–Ω–æ–≤–∏—Ç—å Dashboard - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
```

#### 3. –°–æ–∑–¥–∞–Ω–∏–µ violations:
```bash
# 1. –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ /api/rating/rules
# 2. –û–ø–æ–∑–¥–∞—Ç—å –Ω–∞ —Å–º–µ–Ω—É
# 3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 5 –º–∏–Ω—É—Ç (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/rating/violations - –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞—Ä—É—à–µ–Ω–∏–µ
# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/rating/employees/:id - —Ä–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω —É–º–µ–Ω—å—à–∏—Ç—å—Å—è
```

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **Scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
2. **–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å** –≤ `scheduler.startAll()`:
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç
   - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –º–∏–Ω—É—Ç–∞
3. **–õ–æ–≥–∏** –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ winston logger (–∫–æ–Ω—Å–æ–ª—å + —Ñ–∞–π–ª—ã)
4. **Graceful shutdown** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤—Å–µ—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

---

## üéØ –ò—Ç–æ–≥

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** 
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** 3 –∏–∑ 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º (60%)
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** 1 –∏–∑ 4 —É–ª—É—á—à–µ–Ω–∏–π (25%)
- **–í—Å–µ–≥–æ:** 4 –∑–Ω–∞—á–∏–º—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è + 1 –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å:** 
- ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏: 60% –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è: 25% —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- ‚úÖ **–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 66% –æ—Ç –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á**

**–†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** 
- ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –ª–∏–Ω—Ç–µ—Ä –æ—à–∏–±–∫–∏
- ‚úÖ Backward compatible (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
- ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

**–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç violations –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∏
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –°–≤—è–∑—ã–≤–∞–µ—Ç exceptions —Å violations —á–µ—Ä–µ–∑ foreign key
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞)

