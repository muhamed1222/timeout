# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ø–Ω–¥–µ–∫—Å OAuth

## ‚úÖ –í–∞–∂–Ω–æ: –ù–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∏—á–µ–≥–æ –≤ Supabase Dashboard!

–Ø–Ω–¥–µ–∫—Å OAuth –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã–π endpoint. Supabase Dashboard –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.

---

## –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –Ø–Ω–¥–µ–∫—Å OAuth ‚úÖ (–£–∂–µ —Å–¥–µ–ª–∞–Ω–æ)

1. ‚úÖ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [https://oauth.yandex.ru/](https://oauth.yandex.ru/)
2. ‚úÖ –ù–∞–∂–º–∏—Ç–µ **"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"**
3. ‚úÖ –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**: OutTime
   - **–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã**: Web-—Å–µ—Ä–≤–∏—Å—ã
   - **Redirect URI**: ‚ö†Ô∏è **–í–ê–ñ–ù–û!** –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: `http://localhost:5000/api/auth/yandex/callback` (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
     - ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Supabase callback (`https://xxx.supabase.co/auth/v1/callback`)
     - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä–Ω—ã–π endpoint
     - –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞: `https://yourdomain.com/api/auth/yandex/callback`
4. ‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
   - ‚úÖ –î–æ—Å—Ç—É–ø –∫ –∞–¥—Ä–µ—Å—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã
   - ‚úÖ –î–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∏–Ω—É, –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏, –ø–æ–ª—É
5. ‚úÖ –ü–æ–ª—É—á–∏—Ç–µ:
   - **ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (Client ID): `2710959716ba49f48959f7a533e7aadd` ‚úÖ
   - **–ü–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (Client Secret): `6d9c6fa7a40042a7bebadc3edeb5df77` ‚úÖ

---

## –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚úÖ (–£–∂–µ —Å–¥–µ–ª–∞–Ω–æ)

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env.local`:

```env
# Yandex OAuth
YANDEX_CLIENT_ID=2710959716ba49f48959f7a533e7aadd
YANDEX_CLIENT_SECRET=6d9c6fa7a40042a7bebadc3edeb5df77
FRONTEND_URL=http://localhost:5173
```

‚úÖ **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env.local`!**

### –ì–¥–µ –Ω–∞–π—Ç–∏ .env —Ñ–∞–π–ª?

–ï—Å–ª–∏ —Ñ–∞–π–ª–∞ `.env` –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ (—Ä—è–¥–æ–º —Å `package.json`).

–ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ `.env`:
```env
# Database
DATABASE_URL=postgresql://...

# Supabase
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Yandex OAuth (–î–û–ë–ê–í–¨–¢–ï –≠–¢–û)
YANDEX_CLIENT_ID=–≤–∞—à_yandex_client_id
YANDEX_CLIENT_SECRET=–≤–∞—à_yandex_client_secret
FRONTEND_URL=http://localhost:5173

# Telegram (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
TELEGRAM_BOT_TOKEN=your-token
```

---

## ‚ö†Ô∏è –®–∞–≥ 2 (–ö–†–ò–¢–ò–ß–ù–û): –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Redirect URI –≤ Yandex

**–°–µ–π—á–∞—Å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Yandex —É–∫–∞–∑–∞–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Redirect URI:**
```
https://chkziqbxvdzwhlucfrza.supabase.co/auth/v1/callback  ‚ùå
```

**–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞:**
```
http://localhost:5000/api/auth/yandex/callback  ‚úÖ
```

### –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [https://oauth.yandex.ru/](https://oauth.yandex.ru/)
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "OutTime"
3. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ **"Redirect URI"** –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã"
4. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞: `http://localhost:5000/api/auth/yandex/callback`
5. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**

üìã –ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. —Ñ–∞–π–ª `YANDEX_OAUTH_REDIRECT_URI_FIX.md`

---

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä** (–µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω):
   ```bash
   # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä (Ctrl+C) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞
   npm run dev
   ```

2. **–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** –≤ –±—Ä–∞—É–∑–µ—Ä–µ

3. **–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å"**

4. **–î–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏**:
   - –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å
   - –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ - –≤–æ–∑–≤—Ä–∞—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏)

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å"
2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/api/auth/yandex` (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π endpoint)
3. –°–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç state (–∑–∞—â–∏—Ç–∞ –æ—Ç CSRF) –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ –Ø–Ω–¥–µ–∫—Å OAuth
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ –Ø–Ω–¥–µ–∫—Å–µ
5. –Ø–Ω–¥–µ–∫—Å —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/api/auth/yandex/callback` —Å –∫–æ–¥–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
6. –°–µ—Ä–≤–µ—Ä –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç –∫–æ–¥ –Ω–∞ access token —á–µ—Ä–µ–∑ Yandex API
7. –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Yandex API (`/login.yandex.ru/info`)
8. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase –ø–æ email
9. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π - —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–º–ø–∞–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Supabase
10. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Å—Å–∏—é Supabase –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
11. –§—Ä–æ–Ω—Ç–µ–Ω–¥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–∞–∂–Ω–æ**: –í—Å—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, Supabase –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–µ—Å—Å–∏–π.

---

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ "Yandex OAuth –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
- ‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `YANDEX_CLIENT_ID` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `.env`
- ‚ùå –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### –û—à–∏–±–∫–∞ "Invalid OAuth state"
- ‚ùå –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ cookies —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- ‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `cookie-parser` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (`npm list cookie-parser`)

### –û—à–∏–±–∫–∞ "Failed to exchange code for token"
- ‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `YANDEX_CLIENT_SECRET` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- ‚ùå –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Redirect URI –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Yandex —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å URL —Å–µ—Ä–≤–µ—Ä–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- ‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `SUPABASE_SERVICE_ROLE_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: `console.log` –∏–ª–∏ –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –¥–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –∫–æ–¥:

```typescript
// server/routes/auth-yandex.ts (–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
console.log('YANDEX_CLIENT_ID:', process.env.YANDEX_CLIENT_ID ? '‚úÖ Set' : '‚ùå Missing');
```

---

## –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å

‚ùå –ù–ï –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∏—á–µ–≥–æ –≤ Supabase Dashboard  
‚ùå –ù–ï –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å "Generic OAuth Provider"  
‚ùå –ù–ï –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å Yandex –≤ Supabase Auth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã  

–í—Å—ë —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ! ‚úÖ

---

## –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

–ü—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω:

1. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –≤–∞—à —Ö–æ—Å—Ç–∏–Ω–≥:
   - `YANDEX_CLIENT_ID`
   - `YANDEX_CLIENT_SECRET`
   - `FRONTEND_URL` (–≤–∞—à –ø—Ä–æ–¥–∞–∫—à–µ–Ω URL)

2. –û–±–Ω–æ–≤–∏—Ç–µ Redirect URI –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Yandex –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   - –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞: `https://yourdomain.com/api/auth/yandex/callback`

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

---

## –ì–æ—Ç–æ–≤–æ! üéâ

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ Yandex OAuth –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ - —Ç–∞–º –±—É–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö.
