# üìä Database Monitoring Scripts

–°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î

**–î–ª—è Supabase (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞):**
- ‚ùó –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à –ø—É–±–ª–∏—á–Ω—ã–π IP –≤ Supabase Dashboard ‚Üí Settings ‚Üí Database ‚Üí Connection Pooling ‚Üí Allowed IPs
- –ë–µ–∑ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç—ã –ø–æ–ª—É—á–∞—Ç –æ—à–∏–±–∫—É "Address not in tenant allow_list"
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ VPN –∏–ª–∏ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ

**–î–ª—è —Å–≤–æ–µ–≥–æ PostgreSQL —Å–µ—Ä–≤–µ—Ä–∞:**
- ‚úÖ –ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ë–î (–º–µ—Ç—Ä–∏–∫–∏, –∫—ç—à, –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
npm run db:health

# –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
npm run db:analyze-indexes

# –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ pg_stat_statements
npm run db:analyze-queries

# –° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
npm run db:analyze-queries -- --min-calls=50 --min-time=0.5
```

## üìã –û–ø–∏—Å–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤

### check-database-health.ts

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ Cache hit rate (—Ü–µ–ª—å: >80%)
- ‚úÖ P95/P99 –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ü–µ–ª—å: <500ms/<1000ms)
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (>1s)
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º –ë–î
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ connection pool
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- üîÑ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- üìä –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üêõ –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
================================================================================
CACHE PERFORMANCE
================================================================================

Cache Hit Rate: 85.5% (3420/4000 requests)
‚úÖ Cache hit rate is excellent!

Cache Stats by Key Prefix:
Prefix              | Hits        | Misses      | Hit%
--------------------------------------------------------------------------------
company             |        1245 |         322 | 79.5%
employee            |         889 |         156 | 85.1%
shift               |        1286 |         146 | 89.8%
```

### analyze-indexes.ts

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –¢–æ–ø-20 —Å–∞–º—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã (–∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ)
- –†–∞–∑–º–µ—Ä—ã –∏–Ω–¥–µ–∫—Å–æ–≤
- –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∏–Ω–¥–µ–∫—Å—ã
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- üìÖ –ï–∂–µ–º–µ—Å—è—á–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- üöÄ –ü–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –ë–î –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- üîç –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∑–∞–ø—Ä–æ—Å–æ–≤

### analyze-slow-queries.ts

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –°–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –°–∞–º—ã–µ —á–∞—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ó–∞–ø—Ä–æ—Å—ã —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –æ–±—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
- Cache hit ratio –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ‚ùó –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_stat_statements` –≤ PostgreSQL

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ pg_stat_statements:**

–î–ª—è Supabase:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Supabase
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Database ‚Üí Extensions
3. –ù–∞–π–¥–∏—Ç–µ `pg_stat_statements`
4. –ù–∞–∂–º–∏—Ç–µ Enable

–î–ª—è —Å–≤–æ–µ–≥–æ PostgreSQL:
```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- üîç –ü—Ä–∏ –ø–æ–∏—Å–∫–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üìä –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- üöÄ –ü–µ—Ä–µ–¥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ë–î

## üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫

**–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ:**
```bash
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
npm run db:health
```

**–ï–∂–µ–º–µ—Å—è—á–Ω–æ:**
```bash
# –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
npm run db:health
npm run db:analyze-indexes
npm run db:analyze-queries
```

### Cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

–î–æ–±–∞–≤—å—Ç–µ –≤ crontab –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ë–î –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 9:00)
0 9 * * 1 cd /path/to/project && npm run db:health >> logs/db-health.log 2>&1

# –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –µ–∂–µ–º–µ—Å—è—á–Ω–æ (1-–≥–æ —á–∏—Å–ª–∞ –≤ 9:00)
0 9 1 * * cd /path/to/project && npm run db:analyze-indexes >> logs/db-indexes.log 2>&1
```

### CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à CI/CD pipeline:

```yaml
# .github/workflows/db-health.yml
name: Database Health Check

on:
  schedule:
    - cron: '0 9 * * 1'  # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 9:00
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run db:health
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          API_URL: https://your-production-url.com
```

## üéØ –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

### ‚úÖ –•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
- Cache hit rate: > 80%
- P95 –∑–∞–ø—Ä–æ—Å–æ–≤: < 500ms
- P99 –∑–∞–ø—Ä–æ—Å–æ–≤: < 1000ms
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: < 1% –æ—Ç –≤—Å–µ—Ö
- Connection pool: < 80% –∑–∞–ø–æ–ª–Ω–µ–Ω

### ‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è
- Cache hit rate: 50-80%
- P95 –∑–∞–ø—Ä–æ—Å–æ–≤: 500-1000ms
- P99 –∑–∞–ø—Ä–æ—Å–æ–≤: 1000-2000ms
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: 1-5%

### ‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ
- Cache hit rate: < 50%
- P95 –∑–∞–ø—Ä–æ—Å–æ–≤: > 1000ms
- P99 –∑–∞–ø—Ä–æ—Å–æ–≤: > 2000ms
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: > 5%

## üìù –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### –ù–∏–∑–∫–∏–π cache hit rate (<80%)
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TTL –¥–ª—è –∫—ç—à–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫—ç—à–∞

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `analyze-slow-queries.ts` –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `EXPLAIN ANALYZE` –≤ PostgreSQL
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ —á–µ—Ä–µ–∑ `analyze-indexes.ts`
4. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤

### –ú–Ω–æ–≥–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
2. –£–¥–∞–ª–∏—Ç–µ —Ç–æ—á–Ω–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –≤–∞–∂–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å `CONCURRENTLY`

### –ü–æ–ª–Ω—ã–π connection pool
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Ç–µ—á–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
2. –£–≤–µ–ª–∏—á—å—Ç–µ `max` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—É–ª–∞
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## üîó –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ë–î](../../docs/DATABASE_OPTIMIZATION.md)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É](../../docs/MONITORING.md)
- [PostgreSQL Performance Tips](https://www.postgresql.org/docs/current/performance-tips.html)
- [pg_stat_statements Documentation](https://www.postgresql.org/docs/current/pgstatstatements.html)

