# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã

‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è 0003_add_performance_indexes.sql** —Å–æ–¥–µ—Ä–∂–∏—Ç:
- 30+ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ß–∞—Å—Ç–∏—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (partial indexes) –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è audit log

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ N+1 –ø—Ä–æ–±–ª–µ–º:**
- `ShiftRepository.findByEmployeeIds()` - bulk –∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–æ–≤
- `CompanyRepository.findByIdWithStats()` - JOIN –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ rating recalculation

‚úÖ **–¢–∞–π–º–∞—É—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤:**
- –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (3-5 —Å–µ–∫—É–Ω–¥)
- Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–∞—Ö

‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ >1 —Å–µ–∫—É–Ω–¥—ã –≤ BaseRepository
- –ú–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ Prometheus –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ cache hit/miss –º–µ—Ç—Ä–∏–∫

‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –ö—ç—à –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏ (2 –º–∏–Ω—É—Ç—ã TTL)
- –ö—ç—à –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω (1 –º–∏–Ω—É—Ç–∞ TTL)
- –ú–µ—Ç—Ä–∏–∫–∏ cache hit rate

---

## üîç –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤

### –ú–µ—Ç–æ–¥—ã –∞–Ω–∞–ª–∏–∑–∞

**1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ EXPLAIN ANALYZE:**
```sql
EXPLAIN ANALYZE
SELECT * FROM employee WHERE company_id = 'xxx' AND status = 'active';
```

**2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
```sql
-- –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (>1 —Å–µ–∫—É–Ω–¥–∞)
SET log_min_duration_statement = 1000;
```

**3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Prometheus:**
- –ú–µ—Ç—Ä–∏–∫–∞ `shiftmanager_database_query_duration_seconds` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–µ—Ç—Ä–∏–∫–∞ `shiftmanager_cache_hits_total` –∏ `shiftmanager_cache_misses_total` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ >1 —Å–µ–∫—É–Ω–¥—ã

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

1. **–ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏**
   - –§–∞–π–ª: `server/repositories/ShiftRepository.ts`
   - –ú–µ—Ç–æ–¥: `findActiveByCompanyId()`
   - –ò–Ω–¥–µ–∫—Å: ‚úÖ `idx_shift_status_planned_start`

2. **–†–∞—Å—á–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞**
   - –§–∞–π–ª: `server/repositories/RatingRepository.ts`
   - –ú–µ—Ç–æ–¥: `updateFromViolations()`
   - –ò–Ω–¥–µ–∫—Å: ‚úÖ `idx_violation_employee_created`

3. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–º–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞**
   - –§–∞–π–ª: `server/repositories/ShiftRepository.ts`
   - –ú–µ—Ç–æ–¥: `findByEmployeeId()`
   - –ò–Ω–¥–µ–∫—Å: ‚úÖ `idx_shift_employee_id`

4. **–ü–æ–∏—Å–∫ pending reminders**
   - –§–∞–π–ª: `server/repositories/ReminderRepository.ts`
   - –ú–µ—Ç–æ–¥: `findPending()`
   - –ò–Ω–¥–µ–∫—Å: ‚úÖ `idx_reminder_pending` (partial index)

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**

–ó–∞–ø—Ä–æ—Å—ã, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–µ—Å—è –¥–æ–ª—å—à–µ 1 —Å–µ–∫—É–Ω–¥—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ BaseRepository:
```
[timestamp] WARN: Slow query detected {"operation":"findById","table":"employee","duration":"1.234s"}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:**

–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤:
```bash
tsx scripts/analyze-indexes.ts
```

–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ pg_stat_statements:
```bash
# –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
tsx scripts/analyze-slow-queries.ts

# –° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
tsx scripts/analyze-slow-queries.ts --min-calls=50 --min-time=0.5
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ PostgreSQL:**

```sql
-- –í PostgreSQL
ALTER DATABASE your_database SET log_min_duration_statement = 1000;
-- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª—å—à–µ 1 —Å–µ–∫—É–Ω–¥—ã
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pg_stat_statements:**
```sql
-- –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∞–º—ã—Ö –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
SELECT 
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 20;
```

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

#### A. Batch –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å—ã –≤ —Ü–∏–∫–ª–∞—Ö —Å–æ–∑–¥–∞—é—Ç N+1 –ø—Ä–æ–±–ª–µ–º—É

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bulk –æ–ø–µ—Ä–∞—Ü–∏–∏

```typescript
// ‚ùå –ü–ª–æ—Ö–æ: N+1 –∑–∞–ø—Ä–æ—Å–æ–≤
for (const employee of employees) {
  const shifts = await repositories.shift.findByEmployeeId(employee.id);
}

// ‚úÖ –•–æ—Ä–æ—à–æ: 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö
const employeeIds = employees.map(e => e.id);
const allShifts = await repositories.shift.findByEmployeeIds(employeeIds);
```

#### B. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JOIN –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN

```typescript
// ‚ùå –ü–ª–æ—Ö–æ: 2 –∑–∞–ø—Ä–æ—Å–∞
const company = await repositories.company.findById(id);
const employees = await repositories.employee.findByCompanyId(id);

// ‚úÖ –•–æ—Ä–æ—à–æ: 1 –∑–∞–ø—Ä–æ—Å —Å JOIN
const companyWithStats = await repositories.company.findByIdWithStats(id);
```

#### C. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–¥—Å—á–µ—Ç —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å COUNT() –≤ JOIN

```sql
-- ‚úÖ –•–æ—Ä–æ—à–æ: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π
SELECT 
  company.*,
  COUNT(employee.id) as employee_count
FROM company
LEFT JOIN employee ON employee.company_id = company.id
WHERE company.id = $1
GROUP BY company.id;
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –∏–Ω–¥–µ–∫—Å—ã
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan as index_scans,
  idx_tup_read as tuples_read,
  idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

**–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã (–∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ):**
```sql
-- –ù–∞–π—Ç–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
SELECT 
  schemaname,
  tablename,
  indexname
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND schemaname = 'public'
  AND indexname NOT LIKE '%_pkey'  -- –ù–µ —É–¥–∞–ª—è—Ç—å primary keys
ORDER BY tablename;
```

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –¥–∞—Ç–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å—ã –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

```sql
-- ‚úÖ –ò–Ω–¥–µ–∫—Å –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–∞—Ç–∞–º
CREATE INDEX idx_shift_planned_start_at ON shift(planned_start_at DESC);

-- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ date_trunc –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
SELECT 
  date_trunc('month', planned_start_at) as month,
  COUNT(*) as shift_count
FROM shift
WHERE company_id = $1
GROUP BY month;
```

### 5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à

```typescript
// ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
const stats = await getOrSet(
  `company:${companyId}:stats`,
  async () => await repositories.company.getStats(companyId),
  120 // 2 –º–∏–Ω—É—Ç—ã TTL
);
```

**–ö—ç—à–∏—Ä—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ (totalEmployees, activeShifts) - TTL 2 –º–∏–Ω—É—Ç—ã
- ‚úÖ –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω - TTL 1 –º–∏–Ω—É—Ç–∞
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ cache hit/miss –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—ç—à–∞

**–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞:**
–ö—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–º–µ–Ω, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –Ω–∞—Ä—É—à–µ–Ω–∏–π
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã: –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–º–µ–Ω—ã

### 6. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CONCURRENTLY –¥–ª—è –±–æ–ª—å—à–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

```sql
-- ‚úÖ –î–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CONCURRENTLY
CREATE INDEX CONCURRENTLY idx_large_table_column 
ON large_table(column_name);

-- ‚ö†Ô∏è CONCURRENTLY –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

- **P95 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î:** < 500ms
- **P99 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î:** < 1000ms
- **–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (>1s):** < 1% –æ—Ç –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Cache hit rate:** > 80%

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Prometheus

–ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `/api/metrics`:

```
# Database query duration
shiftmanager_database_query_duration_seconds{operation="findById",table="employee"} 0.023

# Database connections
shiftmanager_database_connections{state="active"} 5
shiftmanager_database_connections{state="idle"} 10
```

---

## üîß –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ:**
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–æ–ø-10 —Å–∞–º—ã—Ö –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å cache hit rate

**–ï–∂–µ–º–µ—Å—è—á–Ω–æ:**
- –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–∏–∑–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å EXPLAIN ANALYZE
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç N+1 –ø—Ä–æ–±–ª–µ–º
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging —Å production-–ø–æ–¥–æ–±–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ connection pooling

**–¢–µ–∫—É—â–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
```typescript
// –í server/repositories/index.ts (postgres.js)
const client = postgres(connectionString, { 
  ssl: connectionString.includes("supabase") ? { rejectUnauthorized: false } : false,
  connect_timeout: 10,        // 10 seconds timeout for connection
  idle_timeout: 20,           // 20 seconds timeout for idle connections
  max_lifetime: 60 * 30,      // 30 minutes max lifetime
  max: 10,                    // Max 10 connections in pool
});
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:**
–ú–µ—Ç—Ä–∏–∫–∞ `shiftmanager_database_connections` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ 0003
- [x] –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ N+1 –ø—Ä–æ–±–ª–µ–º—ã
- [x] –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [x] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Prometheus
- [x] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Å –¥–∞—Ç–∞–º–∏
- [x] –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ connection pooling
- [x] –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ `npm run db:health`
- [ ] –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –∑–∞–ø—É—Å–∫ `npm run db:analyze-indexes`

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [PostgreSQL Performance Tips](https://www.postgresql.org/docs/current/performance-tips.html)
- [PostgreSQL Indexes](https://www.postgresql.org/docs/current/indexes.html)
- [Drizzle ORM Performance](https://orm.drizzle.team/docs/performance)
- [pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)

---

## üìä –°—Ç–∞—Ç—É—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü (30+ –∏–Ω–¥–µ–∫—Å–æ–≤)
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã N+1 –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω –∫—ç—à –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (>1s)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ BaseRepository
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ cache hit/miss rate
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω connection pooling (max: 10, –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã)
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –∞–Ω–∞–ª–∏–∑–∞: analyze-indexes.ts, analyze-slow-queries.ts
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: check-database-health.ts
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã npm –∫–æ–º–∞–Ω–¥—ã: `db:health`, `db:analyze-indexes`, `db:analyze-queries`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- ‚è≥ –†–µ–≥—É–ª—è—Ä–Ω—ã–π –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ `npm run db:health`
- ‚è≥ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –∑–∞–ø—É—Å–∫ `npm run db:analyze-indexes`
- ‚è≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (cron/CI/CD) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üõ†Ô∏è –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ë–î (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ):**
```bash
npm run db:health
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- Cache hit rate (—Ü–µ–ª—å: >80%)
- P95/P99 –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–æ—Å—Ç–æ—è–Ω–∏–µ connection pool
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

**–ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤:**
```bash
npm run db:analyze-indexes
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –°–∞–º—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã (–∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ)
- –†–∞–∑–º–µ—Ä—ã –∏–Ω–¥–µ–∫—Å–æ–≤
- –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∏–Ω–¥–µ–∫—Å—ã
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

**–ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
```bash
# –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
npm run db:analyze-queries

# –° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
npm run db:analyze-queries -- --min-calls=50 --min-time=0.5
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –°–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –°–∞–º—ã–µ —á–∞—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ó–∞–ø—Ä–æ—Å—ã —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –æ–±—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
- Cache hit ratio
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- `pg_stat_statements` —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ PostgreSQL
- –î–ª—è Supabase: –≤–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
–°–º. [scripts/MONITORING_README.md](../scripts/MONITORING_README.md) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ –ø—Ä–∏–º–µ—Ä–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –Ø–Ω–≤–∞—Ä—å 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ë–∞–∑–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

