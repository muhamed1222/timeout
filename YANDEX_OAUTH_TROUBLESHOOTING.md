# üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ Yandex OAuth

## ‚ùå –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

### 1. **"token_exchange_failed"** –∏–ª–∏ **"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–º–µ–Ω—è—Ç—å –∫–æ–¥ –Ω–∞ —Ç–æ–∫–µ–Ω"**

**–ü—Ä–∏—á–∏–Ω—ã:**
- ‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π Redirect URI –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Yandex –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π Client ID –∏–ª–∏ Client Secret
- ‚ùå –ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (–∫–æ–¥—ã –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redirect URI –≤ [Yandex OAuth](https://oauth.yandex.ru/) ‚Üí –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí Redirect URI
   - –î–ª—è development: `http://localhost:3001/api/auth/yandex/callback`
   - –î–ª—è production: `https://–≤–∞—à-–¥–æ–º–µ–Ω.com/api/auth/yandex/callback`
   
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Redirect URI **—Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç** (–≤–∫–ª—é—á–∞—è http/https, –ø–æ—Ä—Ç, —Å–ª–µ—à –≤ –∫–æ–Ω—Ü–µ)

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```bash
   # –í .env.local –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
   YANDEX_CLIENT_ID=–≤–∞—à_client_id
   YANDEX_CLIENT_SECRET=–≤–∞—à_client_secret
   ```

4. **–í–∞–∂–Ω–æ:** –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è Redirect URI –≤ Yandex ‚Äî –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞

---

### 2. **"invalid_state"** –∏–ª–∏ **"–ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å"**

**–ü—Ä–∏—á–∏–Ω—ã:**
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å cookies (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, –æ—á–∏—â–µ–Ω—ã, SameSite)
- ‚ùå State –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –†–∞–∑—Ä–µ—à–∏—Ç–µ cookies –¥–ª—è `localhost:5173` –∏ `localhost:3001`
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ (—á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–µ –æ—á–∏—â–∞–µ—Ç–µ cookies –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

---

### 3. **"no_email"** –∏–ª–∏ **"–í –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ –Ø–Ω–¥–µ–∫—Å –Ω–µ —É–∫–∞–∑–∞–Ω email"**

**–ü—Ä–∏—á–∏–Ω–∞:**
- ‚ùå –í –∞–∫–∫–∞—É–Ω—Ç–µ –Ø–Ω–¥–µ–∫—Å –Ω–µ —É–∫–∞–∑–∞–Ω email –∏–ª–∏ –æ–Ω –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω

**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–π–¥–∏—Ç–µ –≤ [–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ø–Ω–¥–µ–∫—Å ID](https://id.yandex.ru/)
2. –î–æ–±–∞–≤—å—Ç–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞

---

### 4. **"server_config"** –∏–ª–∏ **"OAuth –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"**

**–ü—Ä–∏—á–∏–Ω–∞:**
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `YANDEX_CLIENT_ID` –∏–ª–∏ `YANDEX_CLIENT_SECRET`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª `.env.local` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
   ```bash
   YANDEX_CLIENT_ID=–≤–∞—à_id
   YANDEX_CLIENT_SECRET=–≤–∞—à_secret
   ```
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

### 5. **"user_info_failed"** –∏–ª–∏ **"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"**

**–ü—Ä–∏—á–∏–Ω–∞:**
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ API –Ø–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ –æ–±–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–∞
- ‚ùå –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî —Ç–∞–º –±—É–¥–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Client ID –∏ Secret –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
cat .env.local | grep YANDEX
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã:
```
YANDEX_CLIENT_ID=...
YANDEX_CLIENT_SECRET=...
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redirect URI –≤ Yandex

1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ [Yandex OAuth](https://oauth.yandex.ru/)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª **"Redirect URI"**

   –î–ª—è development –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   http://localhost:3001/api/auth/yandex/callback
   ```

   ‚ö†Ô∏è **–í–ê–ñ–ù–û:** 
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **3001** (–ø–æ—Ä—Ç backend), –∞ –Ω–µ 5173 (–ø–æ—Ä—Ç frontend)!
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ `http://` (–Ω–µ `https://`) –¥–ª—è localhost
   - –ü—É—Ç—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—á–Ω–æ: `/api/auth/yandex/callback`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

```
Yandex OAuth init { callbackUrl: 'http://localhost:3001/api/auth/yandex/callback', ... }
Yandex OAuth callback received { query: {...}, cookies: {...} }
Exchanging code for token { clientId: '...', callbackUrl: '...' }
Token exchange successful
Got access token from Yandex
Fetching user info from Yandex
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∞—Ö ‚Äî —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ—ë –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ —Ç–∞–±–ª–∏—Ü–µ –≤—ã—à–µ.

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å. 

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É:
```
Yandex OAuth error: { error: '...', errorDescription: '...' }
```

–≠—Ç–æ –¥–∞—Å—Ç –≤–∞–º –∫–æ–¥ –æ—à–∏–±–∫–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OAuth –ø–æ—Ç–æ–∫–∞

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å"
2. ‚úÖ Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/auth/yandex`
3. ‚úÖ Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç state, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ cookie, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `oauth.yandex.com`
4. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –≤ –Ø–Ω–¥–µ–∫—Å
5. ‚úÖ –Ø–Ω–¥–µ–∫—Å —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `http://localhost:3001/api/auth/yandex/callback?code=...&state=...`
6. ‚úÖ Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç state, –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç code –Ω–∞ token, –ø–æ–ª—É—á–∞–µ—Ç user info
7. ‚úÖ Backend —Å–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase
8. ‚úÖ Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç magic link –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ frontend —Å —Ç–æ–∫–µ–Ω–æ–º
9. ‚úÖ Frontend —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ Supabase

### –ì–¥–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞:

| –®–∞–≥ | –í–æ–∑–º–æ–∂–Ω–∞—è –æ—à–∏–±–∫–∞ | –†–µ—à–µ–Ω–∏–µ |
|-----|-----------------|---------|
| 2-3 | –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ 3001 |
| 5 | –Ø–Ω–¥–µ–∫—Å –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redirect URI –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Yandex |
| 6 | `token_exchange_failed` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Client ID/Secret –∏ Redirect URI |
| 7 | `user_creation_failed` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase |
| 8-9 | `session_failed` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SUPABASE_SERVICE_ROLE_KEY |

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `YANDEX_CLIENT_ID` –∏ `YANDEX_CLIENT_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ `.env.local`
- [ ] Redirect URI –≤ Yandex –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ `http://localhost:3001/api/auth/yandex/callback`
- [ ] Backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001
- [ ] Frontend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5173
- [ ] Cookies —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] –í –∞–∫–∫–∞—É–Ω—Ç–µ –Ø–Ω–¥–µ–∫—Å —É–∫–∞–∑–∞–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω email

---

## üîÑ –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ

1. **–û—á–∏—Å—Ç–∏—Ç–µ cookies** –¥–ª—è localhost –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä** (`npm run dev`)
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞** ‚Äî —Ç–∞–º –±—É–¥–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º —à–∞–≥–µ OAuth
4. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä** –∏–ª–∏ —Ä–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
5. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Yandex (–Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

---

## üìû –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω `npm run dev`. 
–í—Å–µ –æ—à–∏–±–∫–∏ OAuth –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –ø—Ä–æ—Ü–µ—Å—Å–∞.

